<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../general.ent">
  %general-entities;
]>
<!-- revision 9592 -->

<sect1 id="ch-tools-glibc" role="wrap">
  <?dbhtml filename="glibc.html"?>

  <sect1info condition="script">
    <productname>glibc</productname>
    <productnumber>&glibc-version;</productnumber>
    <address>&glibc-url;</address>
  </sect1info>

  <title>Glibc-&glibc-version;</title>

  <indexterm zone="ch-tools-glibc">
    <primary sortas="a-Glibc">Glibc</primary>
    <secondary>tools</secondary>
  </indexterm>

  <sect2 role="package">
    <title/>

    <xi:include xmlns:xi="http://www.w3.org/2001/XInclude"
    href="../chapter06/glibc.xml"
    xpointer="xpointer(/sect1/sect2[1]/para[2])"/>

    <segmentedlist>
      <segtitle>&buildtime;</segtitle>
      <segtitle>&diskspace;</segtitle>

      <seglistitem>
        <seg>&glibc-ch5-sbu;</seg>
        <seg>&glibc-ch5-du;</seg>
      </seglistitem>
    </segmentedlist>

  </sect2>

  <sect2 role="installation">
    <title>Glibcのインストール</title>

    <para>Fix a bug that prevents Glibc from building with GCC-&gcc-version;:</para>
    <para>GlibcがGCC-&gcc-version;を使ってビルド出来ないバグを修正します：</para>

<screen><userinput remap="pre">patch -Np1 -i ../&glibc-gcc_fix-patch;</userinput></screen>

    <para>Also address a header check that fails due to an incomplete build  
    environment at this point:</para>
    <para>この時点では不完全なビルド環境であるため、処理に失敗するヘッダーチェックを修正します。</para> 

    <screen><userinput remap="pre">patch -Np1 -i ../&glibc-cpuid-patch;</userinput></screen>

    <para>The Glibc documentation recommends building Glibc outside of the source
    directory in a dedicated build directory:</para>

    <para>Glibcのドキュメントでは、ソースディレクトリ外のディレクトリでビルドを行うことを推奨しています。
    </para>

<screen><userinput>mkdir -v ../glibc-build
cd ../glibc-build</userinput></screen>

    <para>Because Glibc no longer supports i386, its developers say to use the
    compiler flag <parameter>-march=i486</parameter> when building it for x86
    machines. There are several ways to accomplish that, but testing shows that
    the flag is best placed inside the build variable <quote>CFLAGS</quote>.
    Instead of overriding completely what Glibc's internal build system uses
    for CFLAGS, append the new flag to the existing contents of CFLAGS by
    making use of the special file <filename>configparms</filename>. The
    -mtune=native flag is also necessary to reset a reasonable value for -mtune
    that is changed when setting -march.</para>
    <para>Glibcはもうi386をサポートしないため、x86マシンでビルドする際、開発者はコンパイラのフラグ<parameter>-march=i486</parameter>を使うように言っています。
    それを行うにはいくつかの方法がありますが、ビルドで使用する変数<quote>CFLAGS</quote>にそのフラグをセットすることが最も良いと、テスト結果が示しています。
    Glibc内部のビルドシステムが使用するCFLAGSを完全に上書きする代わりに、特別なファイル<filename>configparms</filename>を使用することにより、CFLAGSの内容に新しいフラグを追加します。
    -marchフラグをセットする際に変更される、-mtuneフラグに適切な値をセットしなおすために、-mtune=nativeフラグも必要です。
    </para>

<screen><userinput remap="configure">case `uname -m` in
  i?86) echo "CFLAGS += -march=i486 -mtune=native" &gt; configparms ;;
esac</userinput></screen>

    <para>Next, prepare Glibc for compilation:</para>
    <para>次にGlibcをコンパイルする準備を行います：</para>

<screen><userinput remap="configure">../glibc-&glibc-version;/configure --prefix=/tools \
    --host=$LFS_TGT --build=$(../glibc-&glibc-version;/scripts/config.guess) \
    --disable-profile --enable-add-ons \
    --enable-kernel=2.6.25 --with-headers=/tools/include \
    libc_cv_forced_unwind=yes libc_cv_c_cleanup=yes</userinput></screen>

    <variablelist>
      <title>configureオプションの意味：</title>

      <varlistentry> 
        <term><parameter>--host=$LFS_TGT, --build=$(../glibc-&glibc-version;/scripts/config.guess)</parameter></term> 
        <listitem> 
          <para>The combined effect of these switches is that Glibc's build system 
          configures itself to cross-compile, using the cross-linker and 
          cross-compiler in <filename class="directory">/tools</filename>.</para>
          <para>これら複数のオプションによって、<filename class="directory">/tools</filename>にあるクロスリンカ、クロスコンパイラを使って、Glibc自身のビルドをクロスコンパイルするように指定します。</para> 
        </listitem> 
      </varlistentry>

      <varlistentry>
        <term><parameter>--disable-profile</parameter></term>
        <listitem>
          <para>This builds the libraries without profiling information. Omit
          this option if profiling on the temporary tools is necessary.</para>
          <para>プロファイリング情報なしのライブラリをビルドします。
          テンポラリのツールにプロファイリング情報が必要であれば、このオプションを外して下さい。
          </para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter>--enable-add-ons</parameter></term>
        <listitem>
          <para>This tells Glibc to use the NPTL add-on as its threading
          library.</para>
          <para>NPTLアドオンをスレッドライブラリとして使用します。</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter>--enable-kernel=2.6.25</parameter></term>
        <listitem>
          <para>This tells Glibc to compile the library with support
          for 2.6.25 and later Linux kernels.  Workarounds for older
          kernels are not enabled.</para>
          <para>Linuxカーネル 2.6.22.5以降をサポートするライブラリをコンパイルします。
          これよりも古いカーネルでは利用不可能です。</para>
        </listitem>
      </varlistentry>

      <varlistentry>
        <term><parameter>--with-headers=/tools/include</parameter></term>
        <listitem>
          <para>This tells Glibc to compile itself against the headers recently
          installed to the tools directory, so that it knows exactly what
          features the kernel has and can optimize itself accordingly.</para>
          <para>Glibcが、カーネルが持つ機能を正確に把握し、最適化が出来るようにするため、toolsディレクトリにインストールしたヘッダを使用して、Glibcをコンパイルします。
          </para>
        </listitem>
      </varlistentry>
<!--ここから-->
      <varlistentry>
        <term><parameter>libc_cv_forced_unwind=yes</parameter></term>
        <listitem>
          <para>The linker installed during
          <xref linkend="ch-tools-binutils-pass1"/> was cross-compiled and as
          such cannot be used until Glibc has been installed.  This means that
          the configure test for force-unwind support will fail, as it relies on
          a working linker.  The libc_cv_forced_unwind=yes variable is passed in
          order to inform <command>configure</command>  that force-unwind
          support is available without it having to run the test.</para>
          <para><xref linkend="ch-tools-binutils-pass1"/>でインストールしたリンカはクロスコンパイルされており、Glibcがインストールされるまで使用することが出来ません。
          このことは、force-unwindサポートのconfigureチェックが、動作しているリンカに依存しているため失敗することを意味しています。
          <command>configure</command>に対して、force-unwindサポートが有効であることを伝えるために、libc_cv_forced_unwind=yesの指定を行います。</para>
        </listitem>
      </varlistentry>
      <varlistentry> 
        <term><parameter>libc_cv_c_cleanup=yes</parameter></term> 
        <listitem>
          <para>Simlarly, we pass libc_cv_c_cleanup=yes through to the
          <command>configure</command> script so that the test is skipped and C
          cleanup handling support is configured.</para>
          <para>同じように、configureによるチェックをスキップし、C cleanup handlingサポートが有効になるように、libc_cv_c_cleanup=yesを<command>configure</command>スクリプトに渡します。</para>
        </listitem>
      </varlistentry>

    </variablelist>

    <para>During this stage the following warning might appear:</para>
    <para>configureの実行時、次のワーニングが出力されるはずです：</para>

    <blockquote>
<screen><computeroutput>configure: WARNING:
*** These auxiliary programs are missing or
*** incompatible versions: msgfmt
*** some features will be disabled.
*** Check the INSTALL file for required versions.</computeroutput></screen>
    </blockquote>

    <para>The missing or incompatible <command>msgfmt</command> program is
    generally harmless. This <command>msgfmt</command> program is part of the
    Gettext package which the host distribution should provide. </para>

    <para><command>msgfmt</command>がmissingまたはincompatibleであることは、ほとんどの場合問題ありません。
    この<command>msgfmt</command>プログラムはホストシステムのディストリビューションが提供すべきGettextパッケージの一部分です。
    </para>

    <para>Compile the package:</para>
    <para>コンパイルを行います：</para>

<screen><userinput remap="make">make</userinput></screen>

    <para>This package does come with a test suite, however, it cannot be
    run at this time because we do not have a C++ compiler yet.</para>
    <para>このパッケージにはテストツールが付属していますが、まだC++コンパイラが導入されていないため、この時点でテストを実行することは出来ません。</para>

    <note> 
      <para>The test suite also requires locale data to be installed in order to run 
      successfully. Locale data provides information to the system regarding 
      such things as the date, time, and currency formats accepted and output by 
      system utilities. If the test suites are not being run in this chapter 
      (as per the recommendation), there is no need to install the locales now. 
      The appropriate locales will be installed in the next chapter. To install 
      the Glibc locales anyway, use instructions from <xref 
      linkend="ch-system-glibc" role="."/></para>
      <para>Glibcのテストを成功させるためにはロケールデータをインストールする必要があります。
      ロケールデータは、システムユーティリティによって処理・出力される日付・時刻・通貨のフォーマットのような情報をシステムに提供します。
      もしテストツールを(推奨のとおり)この章で実行しない場合、現時点でロケールデータをインストールする必要はありません。
      適切なロケールデータは次の章でインストールされます。
      どうにかしてGlibcのロケールデータをインストールするには、<xref linkend="ch-system-glibc" role="."/>の手順を実行してください。 </para>
    </note>

    <para>Install the package:</para>
    <para>パッケージのインストール：</para>

<screen><userinput remap="install">make install</userinput></screen>

  </sect2>

  <sect2 role="content">
    <title/>

    <para>Details on this package are located in
    <xref linkend="contents-glibc" role="."/></para>
    <para>このパッケージの詳細は、<xref linkend="contents-glibc" role="."/>にあります。
    </para>
  </sect2>

</sect1>
